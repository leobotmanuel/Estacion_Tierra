#include <Adafruit_GFX.h>
#include <Adafruit_ST7789.h>
#include <SPI.h>
#include <SD.h>
#include <LoRa.h>
#include <Wire.h>

File Fichero;

int contador_paquetes = 0;

void setup(void) {
  Wire.begin();
  if (!SD.begin(3))
  {
    return;
  }
  
  if (!LoRa.begin(868E6)) {
    while (1);
  }
  Fichero = SD.open("cansat.csv", FILE_WRITE);
  if (Fichero) {
    Fichero.println("Tiempo(s),AcelerometroX,AcelerometroY,AcelerometroZ,GiroscopioX,GiroscopioY,GiroscopioZ,MagnetometroX,MagnetometroY,MagnetometroZ,PresionGiro(mbar),TemperaturaGiro(degC),AltitudGiro(m),LatitudGPS,LongitudGPS,velocidadGPS,altitudGPS,temperaturaBME,presionBME,humedadBME,altitudBME,CO2,GasesVolatiles,DUV");
    Fichero.close();
  }
}

void loop() {
  delay(1000);
  int packetSize = LoRa.parsePacket();
  String datos = "";
  if (packetSize) {
    contador_paquetes += 1;
    while (LoRa.available()) {
      datos += (char)LoRa.read();
    }

    Fichero = SD.open("cansat.csv", FILE_WRITE);
    Fichero.println(datos);
    Fichero.close();
  }

  Wire.beginTransmission(4); // transmit to device #4
  Wire.write("holaaaa");              // sends one byte  datos.c_str()
  Wire.endTransmission();    // stop transmitting
}
